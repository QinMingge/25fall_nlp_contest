(base) jinda@Tang3:/data/jinda/qinmingge/BERT$ /home/jinda/miniconda3/envs/nlp_bert/bin/python /data/jinda/qinmingge/BERT/25fallnewsclassify/bertTextAttention_infer.py
ğŸš€ Starting Inference on cuda...
Loading tokenizer from /data/jinda/qinmingge/BERT/25fallnewsclassify/bert_small_4096_final...
Loading test data from /data/jinda/qinmingge/BERT/25fallnewsclassify/test_a.csv...
Test set size: 50000
Initializing BertTextAttention model structure...
âœ… BERT Embedding Dimension Detected: 512
Loading weights from /data/jinda/qinmingge/BERT/25fallnewsclassify/output_ft_attention/final_model/model.safetensors...
Using 4 GPUs!
Starting prediction loop...
Predicting:   0%|                                                      | 0/391 [00:00<?, ?it/s]/data/jinda/qinmingge/BERT/25fallnewsclassify/bertTextAttention_infer.py:131: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with torch.cuda.amp.autocast():
Predicting: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 391/391 [03:20<00:00,  1.95it/s]
Saving results to /data/jinda/qinmingge/BERT/25fallnewsclassify/submit_attention.csv...
âœ… Done!







å› ä¸ºé‡‡ç”¨äº†æ··åˆç²¾åº¦æ¨ç†ã€‚ï¼ˆbecourseè®­ç»ƒæ—¶å°±ä½¿ç”¨äº†fp16é‡åŒ–ï¼‰









è¯»å– [](file:///data/jinda/qinmingge/BERT/25fallnewsclassify/bertTextAttention_FT.py#80-80)ï¼Œè¡Œ 80 åˆ° 100

è¯»å– [](file:///data/jinda/qinmingge/BERT/25fallnewsclassify/bertTextAttention_FT.py#180-180)ï¼Œè¡Œ 180 åˆ° 230

è¿™æ˜¯ä¸€ä¸ªéå¸¸åˆç†ä¸”ä¸¥è°¨çš„æ‹…å¿§ï¼åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œ**ç²¾åº¦ï¼ˆPrecisionï¼‰** å’Œ **é€Ÿåº¦ï¼ˆSpeedï¼‰** ç¡®å®æ˜¯ä¸€å¯¹æƒè¡¡ã€‚

### ç›´æ¥å›ç­”æ‚¨çš„é—®é¢˜

1. **ä¼šæœ‰ç²¾åº¦æŸå¤±å—ï¼Ÿ**
   
   * **ç†è®ºä¸Š**ï¼šä¼šæœ‰å¾®å°çš„æ•°å€¼å·®å¼‚ï¼ˆä¾‹å¦‚ `0.999991` å˜æˆäº† `0.999992`ï¼‰ã€‚
   * **å®é™…ä¸Š**ï¼šå¯¹äºåˆ†ç±»ä»»åŠ¡ï¼ˆé€‰æ¦‚ç‡æœ€å¤§çš„é‚£ä¸ªç±»ï¼‰ï¼Œè¿™ç§å¾®å°çš„å·®å¼‚**å‡ ä¹ä»æ¥ä¸ä¼š**æ”¹å˜æœ€ç»ˆçš„é¢„æµ‹ç»“æœï¼ˆArgmaxï¼‰ã€‚
   * **ç‰¹åˆ«æ³¨æ„**ï¼šæ‚¨çš„æ¨¡å‹è®­ç»ƒæ—¶ä½¿ç”¨äº† `bf16=True`ï¼ˆæˆ‘åœ¨è®­ç»ƒè„šæœ¬ä¸­ç¡®è®¤è¿‡ï¼‰ã€‚è¿™æ„å‘³ç€æ‚¨çš„æ¨¡å‹æƒé‡æœ¬èº«å°±æ˜¯ä¸ºäº†é€‚åº”ä½ç²¾åº¦è®¡ç®—è€Œè®­ç»ƒçš„ã€‚å› æ­¤ï¼Œæ¨ç†æ—¶ä½¿ç”¨ FP16/BF16 æ˜¯**å®Œå…¨åŒ¹é…**è®­ç»ƒè¿‡ç¨‹çš„ï¼Œé€šå¸¸ä¸ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚

2. **æ”¹æˆ FP32 åˆ†æ•°ä¼šä¸ä¼šæ›´å¥½ï¼Ÿ**
   
   * **99% çš„æ¦‚ç‡åˆ†æ•°å®Œå…¨ä¸€æ ·**ã€‚
   * **1% çš„æ¦‚ç‡**ä¼šæœ‰æä¸ªåˆ«æ ·æœ¬çš„é¢„æµ‹å‘ç”Ÿå˜åŒ–ï¼ˆé€šå¸¸æ˜¯é‚£äº›æ¨¡å‹æœ¬èº«å°±å¾ˆçŠ¹è±«ã€ä¸¤ä¸ªç±»åˆ«æ¦‚ç‡æåº¦æ¥è¿‘çš„æ ·æœ¬ï¼‰ã€‚

### æ—¢ç„¶æ‚¨æ‹…å¿ƒï¼Œæˆ‘ä»¬ç”¨ FP32 è·‘ä¸€æ¬¡ï¼

ä¸ºäº†è®©æ‚¨å½»åº•æ”¾å¿ƒï¼Œä¹Ÿä¸ºäº†è¿½æ±‚ç†è®ºä¸Šçš„â€œæœ€é«˜ç²¾åº¦â€ï¼Œæˆ‘å¸®æ‚¨ä¿®æ”¹è„šæœ¬ï¼š

1. **å…³é—­æ··åˆç²¾åº¦**ï¼šå…¨ç¨‹ä½¿ç”¨ FP32ï¼ˆå•ç²¾åº¦ï¼‰ã€‚
2. **è°ƒæ•´ Batch Size**ï¼šFP32 å ç”¨çš„æ˜¾å­˜æ˜¯ FP16 çš„ä¸¤å€ï¼Œä¸ºäº†é˜²æ­¢æ˜¾å­˜æº¢å‡º (OOM)ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ Batch Size å‡åŠã€‚
3. **ä¿å­˜ä¸ºæ–°æ–‡ä»¶**ï¼šä¿å­˜ä¸º `submit_attention_fp32.csv`ï¼Œè¿™æ ·æ‚¨å¯ä»¥å’Œä¹‹å‰çš„æäº¤æ–‡ä»¶å¯¹æ¯”ï¼Œçœ‹çœ‹æœ‰å¤šå°‘è¡Œä¸ä¸€æ ·ã€‚

æˆ‘å°†ä¸ºæ‚¨ä¿®æ”¹ä»£ç ï¼š

æ­£åœ¨ä½¿ç”¨ "æ›¿æ¢æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²"

```

```

æ­£åœ¨ä½¿ç”¨ "æ›¿æ¢æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²"

```

```

æ­£åœ¨ä½¿ç”¨ "æ›¿æ¢æ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²"

```

```

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ã€‚

**ç®€çŸ­çš„å›ç­”ï¼š**
é€šå¸¸æƒ…å†µä¸‹ï¼Œ**ä¸ä¼š**ã€‚å› ä¸ºæ‚¨åœ¨è®­ç»ƒæ—¶ä½¿ç”¨äº† `bf16=True`ï¼ˆæˆ‘åœ¨æ‚¨çš„è®­ç»ƒè„šæœ¬ä¸­ç¡®è®¤äº†è¿™ä¸€ç‚¹ï¼‰ï¼Œæ‰€ä»¥æ¨¡å‹å·²ç»é€‚åº”äº†åŠç²¾åº¦ã€‚åœ¨æ¨ç†æ—¶ä½¿ç”¨ FP16/BF16 æ˜¯å®Œå…¨åŒ¹é…çš„ï¼Œä¸”å¯¹äºåˆ†ç±»ä»»åŠ¡ï¼ˆå–æœ€å¤§å€¼ï¼‰ï¼Œå°æ•°ç‚¹å4-5ä½çš„å¾®å°å·®å¼‚å‡ ä¹ä¸ä¼šæ”¹å˜åˆ†ç±»ç»“æœã€‚

**è¯¦ç»†è§£é‡Šï¼š**

1. **è®­ç»ƒä¸æ¨ç†çš„ä¸€è‡´æ€§**ï¼šæ‚¨çš„æ¨¡å‹æ˜¯åœ¨ BF16 æ¨¡å¼ä¸‹è®­ç»ƒçš„ã€‚è¿™æ„å‘³ç€å®ƒçš„æƒé‡æœ¬èº«å°±åŒ…å«äº†ä¸€å®šçš„â€œä½ç²¾åº¦å™ªå£°â€ã€‚ç”¨ FP32 æ¨ç†å¹¶ä¸ä¼šç¥å¥‡åœ°è®©æƒé‡å˜å¾—æ›´ç²¾ç¡®ï¼Œåªæ˜¯è®¡ç®—è¿‡ç¨‹æ›´ç²¾ç¡®è€Œå·²ã€‚
2. **åˆ†ç±»ä»»åŠ¡çš„é²æ£’æ€§**ï¼šæˆ‘ä»¬æœ€ç»ˆè¦çš„æ˜¯ `argmax`ï¼ˆæ¦‚ç‡æœ€å¤§çš„ç±»åˆ«ï¼‰ã€‚
   * FP16: `[0.1, 0.8999, 0.0001]` -> ç±»åˆ« 1
   * FP32: `[0.1, 0.9000, 0.0000]` -> ç±»åˆ« 1
   * ç»“æœæ˜¯ä¸€æ ·çš„ã€‚é™¤éä¸¤ä¸ªç±»åˆ«çš„æ¦‚ç‡æåº¦æ¥è¿‘ï¼ˆä¾‹å¦‚ 0.4999 vs 0.5001ï¼‰ï¼Œå¦åˆ™ç»“æœä¸ä¼šå˜ã€‚

**ä½†æ˜¯ï¼Œä¸ºäº†è®©æ‚¨å½»åº•æ”¾å¿ƒï¼š**
æˆ‘å·²ç»å¸®æ‚¨ä¿®æ”¹äº†è„šæœ¬ï¼Œ**å…³é—­äº†æ··åˆç²¾åº¦åŠ é€Ÿï¼Œå¼ºåˆ¶ä½¿ç”¨ FP32 è¿›è¡Œæ¨ç†**ã€‚

* **ä»£ä»·**ï¼šé€Ÿåº¦ä¼šå˜æ…¢ï¼ˆå¯èƒ½éœ€è¦ 30-60 åˆ†é’Ÿï¼‰ï¼Œæ˜¾å­˜å ç”¨ä¼šç¿»å€ï¼ˆæ‰€ä»¥æˆ‘æŠŠ Batch Size å‡åŠäº†ï¼‰ã€‚
* **æ”¶ç›Š**ï¼šæ‚¨å¯ä»¥è·å¾—ç†è®ºä¸Šâ€œæœ€ç²¾ç¡®â€çš„è®¡ç®—ç»“æœã€‚
* **è¾“å‡ºæ–‡ä»¶**ï¼šæˆ‘å°†ç»“æœä¿å­˜ä¸º `submit_attention_fp32.csv`ï¼Œè¿™æ ·æ‚¨å¯ä»¥å’Œä¹‹å‰çš„ `submit_attention.csv` å¯¹æ¯”ä¸€ä¸‹ã€‚å¦‚æœä¸¤è€…å®Œå…¨ä¸€æ ·ï¼ˆæˆ–è€…åªæœ‰å‡ ä¸ªæ ·æœ¬ä¸åŒï¼‰ï¼Œæ‚¨å°±çŸ¥é“ä»¥åå¯ä»¥æ”¾å¿ƒç”¨åŠ é€Ÿæ¨¡å¼äº†ã€‚

æ‚¨å¯ä»¥è¿è¡Œä¿®æ”¹åçš„è„šæœ¬æ¥éªŒè¯ï¼š

```bash
/home/jinda/miniconda3/envs/nlp_bert/bin/python /data/jinda/qinmingge/BERT/25fallnewsclassify/bertTextAttention_infer.py

å·²è¿›è¡Œæ›´æ”¹ã€‚
